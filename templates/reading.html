{% extends "layout.html" %}

{% block title %}Okuma AlÄ±ÅŸtÄ±rmasÄ±{% endblock %}

{% block extra_css %}
<style>
    .highlight-evidence {
        background-color: #fef08a; 
        border-radius: 4px; padding: 2px 0;
        box-shadow: 0 0 10px rgba(253, 224, 71, 0.5);
    }
    .dark .highlight-evidence {
        background-color: #854d0e; color: #fefce8;
    }
    #translationBubble { transition: opacity 0.2s, transform 0.2s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    
    /* Ses ikonu animasyonu */
    .speaking-animation { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
        70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }
</style>
{% endblock %}

{% block content %}
<div id="exam-toast" class="fixed bottom-5 right-5 z-50 hidden animate-bounce">
    <div class="bg-white border-l-4 border-red-600 rounded-lg shadow-2xl p-6 max-w-sm">
        <h3 class="font-bold text-gray-900 text-lg">Seviye SÄ±nÄ±rÄ±!</h3>
        <p class="text-sm text-gray-600 mt-1">XP limitine ulaÅŸtÄ±n. SÄ±nava girmezsen XP kazanamazsÄ±n.</p>
        <div class="mt-4 flex gap-3">
            <a href="/exam_page?skill=reading" class="px-4 py-2 bg-red-600 text-white text-sm font-bold rounded">SÄ±nava Gir</a>
            <button onclick="closeToast()" class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-bold rounded">Daha Sonra</button>
        </div>
    </div>
</div>

<div class="max-w-5xl mx-auto pt-20 pb-6 md:pt-4">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 px-4 md:px-0">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-white text-center md:text-left">Okuma ve Anlama</h2>
        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Seviyen: {{ level }}</span>
    </div>

    <div id="startContainer" class="w-full max-w-5xl mx-auto bg-white dark:bg-gray-800 p-6 md:p-10 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 text-center relative min-h-[400px] flex flex-col items-center justify-center">
        <div id="loader" class="hidden absolute inset-0 bg-white/95 dark:bg-gray-800/95 z-50 flex flex-col items-center justify-center rounded-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-600 mb-4"></div>
            <span id="loaderText" class="text-gray-600 dark:text-gray-300 font-medium animate-pulse">Hikaye oluÅŸturuluyor...</span>
        </div>
        <div class="w-24 h-24 bg-indigo-50 dark:bg-indigo-900/30 rounded-full flex items-center justify-center mb-6 animate-fade-in">
            <svg class="w-12 h-12 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
        </div>
        <h3 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">Okumaya HazÄ±r MÄ±sÄ±n?</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-10 max-w-lg text-lg">Yapay zeka senin iÃ§in metin ve sorular hazÄ±rlayacak. Metni okuyup sorularÄ± cevapla ve XP kazan.</p>
        <button onclick="startReading()" class="px-10 py-4 bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-bold rounded-xl shadow-lg transition transform hover:-translate-y-1">Dersi BaÅŸlat</button>
    </div>

    <div id="activeContent" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 relative animate-fade-in">
        
        <div class="lg:col-span-7">
            <div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700 sticky top-4">
                <div id="readingScreen">
                    <div class="flex justify-between items-start mb-4 border-b border-gray-100 dark:border-gray-700 pb-4">
                        <h2 id="textTitle" class="text-2xl font-bold text-gray-800 dark:text-white leading-tight"></h2>
                        
                        <button onclick="toggleAudio()" id="audioBtn" class="shrink-0 w-10 h-10 bg-gray-100 dark:bg-gray-700 text-indigo-600 dark:text-indigo-400 rounded-full flex items-center justify-center transition hover:bg-indigo-50 dark:hover:bg-gray-600" title="Sesli Oku / Durdur">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                        </button>
                    </div>
                    
                    <div id="textContent" class="text-lg leading-relaxed text-gray-700 dark:text-gray-300 font-serif cursor-text" onmouseup="handleSelection()"></div>
                </div>
                <div id="translationBubble" class="hidden absolute bg-gray-900 text-white text-sm px-3 py-2 rounded-lg shadow-xl z-50 max-w-xs pointer-events-none transform -translate-x-1/2">
                    <div id="translationResult">Ã‡evriliyor...</div>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1 w-2 h-2 bg-gray-900 rotate-45"></div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-5 space-y-6">
            
            <div id="summaryCard" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-sm">1</div>
                    <h3 class="font-bold text-gray-800 dark:text-white">Ã–zet Ã‡Ä±karma</h3>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">OkuduÄŸunu anladÄ±n mÄ±? KÄ±saca Ã¶zetle.</p>
                <textarea id="summaryInput" rows="6" class="w-full p-3 border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 rounded-lg focus:border-indigo-500 focus:ring-0 text-sm resize-none" placeholder="Metin ne hakkÄ±nda? Kendi cÃ¼mlelerinle yaz..."></textarea>
            </div>

            <div id="quizCard" class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center font-bold text-sm">2</div>
                    <h3 class="font-bold text-gray-800 dark:text-white">Kavrama Testi</h3>
                </div>
                <div id="questionsArea" class="space-y-6"></div>
            </div>

            <button onclick="finishLesson()" id="finishBtn" class="w-full py-4 bg-indigo-600 dark:bg-indigo-600 hover:bg-indigo-700 dark:hover:bg-indigo-500 text-white font-bold rounded-xl shadow-xl transition transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-2">
                <span>Tamamla ve GÃ¶nder</span>
            </button>

            <div id="finalResultCard" class="hidden bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-xl border-2 border-indigo-100 dark:border-indigo-900 animate-fade-in">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-extrabold text-gray-900 dark:text-white">SonuÃ§ Raporu</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Ders tamamlandÄ±!</p>
                </div>

                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-xl text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Ã–zet PuanÄ±</p>
                        <p id="resAiScore" class="text-xl font-black text-gray-600 dark:text-gray-300">-</p>
                    </div>
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-xl text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold">Test</p>
                        <p id="resQuizScore" class="text-xl font-black text-gray-600 dark:text-gray-300">-</p>
                    </div>
                    <div class="p-3 bg-indigo-50 dark:bg-indigo-900/30 border border-indigo-100 dark:border-indigo-800 rounded-xl text-center">
                        <p class="text-[10px] text-indigo-500 uppercase font-bold">Genel Skor</p>
                        <p id="resFinalScore" class="text-2xl font-black text-indigo-700 dark:text-indigo-400">-</p>
                    </div>
                </div>

                <div class="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-xl border border-indigo-100 dark:border-indigo-800 flex items-center justify-between mb-6">
                    <span class="font-bold text-indigo-900 dark:text-indigo-200">KazanÄ±lan XP:</span>
                    <span id="resXpGain" class="text-xl font-black text-indigo-600 dark:text-indigo-400"></span>
                </div>

                <div class="mb-6">
                    <p class="text-xs text-gray-400 uppercase font-bold mb-1">Yapay Zeka Yorumu:</p>
                    <p id="resFeedback" class="text-sm text-gray-700 dark:text-gray-300 italic bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg"></p>
                </div>

                <button onclick="location.reload()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">
                    Yeni Ders BaÅŸlat
                </button>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentData = null;
        let originalTextRaw = "";
        let synthesis = window.speechSynthesis;
        let utterance = null;
        
        // Elementler
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const startContainer = document.getElementById('startContainer');
        const activeContent = document.getElementById('activeContent');
        const textTitle = document.getElementById('textTitle');
        const textContent = document.getElementById('textContent');
        const level = "{{level}}";
        
        const questionsArea = document.getElementById('questionsArea');
        const summaryInput = document.getElementById('summaryInput');
        const finishBtn = document.getElementById('finishBtn');
        const finalResultCard = document.getElementById('finalResultCard');
        const summaryCard = document.getElementById('summaryCard');
        const quizCard = document.getElementById('quizCard');

        // --- 1. DERSÄ° BAÅžLAT ---
        window.startReading = async function() {
            toggleLoader(true, "Yapay zeka metni yazÄ±yor ve sorularÄ± hazÄ±rlÄ±yor...");
            try {
                const res = await fetch(`/api/generate_reading?level=${level}`);
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                currentData = data;
                originalTextRaw = data.text; 
                textTitle.innerText = data.title;
                textContent.innerHTML = formatText(data.text);
                
                

                renderQuiz();
                startContainer.classList.add('hidden');
                activeContent.classList.remove('hidden');
                if(window.lucide) lucide.createIcons();
                
            } catch (e) {
                alert("Hata: " + e.message);
            } finally {
                toggleLoader(false);
            }
        };

        // --- 2. QUÄ°Z RENDER ---
        function renderQuiz() {
            questionsArea.innerHTML = ""; 
            currentData.questions.forEach((q, index) => {
                const qDiv = document.createElement('div');
                qDiv.className = "p-4 border border-gray-200 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700";
                qDiv.id = `q_card_${index}`;
                
                let optionsHtml = "";
                q.options.forEach((opt, optIndex) => {
                    const optId = `q${index}_opt${optIndex}`;
                    optionsHtml += `
                        <label id="lbl_${optId}" class="flex items-center gap-3 p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition mb-2">
                            <input type="radio" id="${optId}" name="q_${index}" value="${optIndex}" class="text-indigo-600 focus:ring-indigo-500" onchange="checkAnswer(${index}, ${optIndex}, ${q.correct_index})">
                            <span class="text-sm text-gray-700 dark:text-gray-200">${opt}</span>
                        </label>
                    `;
                });

                qDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <p class="font-bold text-gray-800 dark:text-gray-200 text-sm"><span class="text-indigo-600">Q${index+1}.</span> ${q.question}</p>
                        <button onclick="highlightEvidence(${index})" class="text-xs text-indigo-500 hover:text-indigo-700 underline ml-2 shrink-0">KanÄ±t</button>
                    </div>
                    <div class="flex flex-col">${optionsHtml}</div>
                    <div id="feedback_${index}" class="hidden mt-2 text-xs font-bold"></div>
                `;
                questionsArea.appendChild(qDiv);
            });
        }

        // --- 3. ANLIK CEVAP KONTROLÃœ ---
        window.checkAnswer = function(qIndex, selectedIndex, correctIndex) {
            const feedback = document.getElementById(`feedback_${qIndex}`);
            feedback.classList.remove('hidden');
            
            const radios = document.getElementsByName(`q_${qIndex}`);
            radios.forEach(r => r.disabled = true);

            const selectedLbl = document.getElementById(`lbl_q${qIndex}_opt${selectedIndex}`);
            
            if(selectedIndex === correctIndex) {
                feedback.className = "mt-2 text-xs font-bold text-green-600 dark:text-green-400";
                feedback.innerText = "DoÄŸru! ðŸŽ‰";
                selectedLbl.classList.add('bg-green-100', 'border-green-300', 'dark:bg-green-900/50');
            } else {
                feedback.className = "mt-2 text-xs font-bold text-red-600 dark:text-red-400";
                feedback.innerText = "YanlÄ±ÅŸ.";
                selectedLbl.classList.add('bg-red-100', 'border-red-300', 'dark:bg-red-900/50');
                
                const correctLbl = document.getElementById(`lbl_q${qIndex}_opt${correctIndex}`);
                if(correctLbl) correctLbl.classList.add('ring-2', 'ring-green-500');

                const q = currentData.questions[qIndex];
                if(q.evidence) highlightEvidence(qIndex);
            }
        };

        // --- 4. SES Ä°KONU VE OKUMA (DÃœZELTÄ°LDÄ°) ---
        window.toggleAudio = function() {
            const btn = document.getElementById('audioBtn');
            const svgIcon = btn.querySelector('svg');

            if(synthesis.speaking) {
                synthesis.cancel();
                // Reset UI (Maviye DÃ¶n)
                btn.classList.remove('text-red-600', 'bg-red-50', 'dark:text-red-400', 'dark:bg-red-900/30', 'speaking-animation');
                btn.classList.add('text-indigo-600', 'bg-gray-100', 'dark:text-indigo-400', 'dark:bg-gray-700');
                return;
            }

            const u = new SpeechSynthesisUtterance(originalTextRaw);
            u.lang = 'en-US'; 
            u.rate = 0.9;

            // Okuma baÅŸladÄ±ÄŸÄ±nda (KÄ±rmÄ±zÄ± Yap)
            u.onstart = () => {
                btn.classList.remove('text-indigo-600', 'bg-gray-100', 'dark:text-indigo-400', 'dark:bg-gray-700');
                btn.classList.add('text-red-600', 'bg-red-50', 'dark:text-red-400', 'dark:bg-red-900/30', 'speaking-animation');
            };

            // Okuma bittiÄŸinde (Maviye DÃ¶n - Reset)
            u.onend = () => {
                btn.classList.remove('text-red-600', 'bg-red-50', 'dark:text-red-400', 'dark:bg-red-900/30', 'speaking-animation');
                btn.classList.add('text-indigo-600', 'bg-gray-100', 'dark:text-indigo-400', 'dark:bg-gray-700');
            };

            synthesis.speak(u);
        };

        // --- 5. DERSÄ° BÄ°TÄ°R ---
        window.finishLesson = async function() {
            const btn = document.getElementById('finishBtn');
            const summary = summaryInput.value.trim();
            if(summary.length < 10) {
                alert("LÃ¼tfen en az bir cÃ¼mlelik Ã¶zet yazÄ±n.");
                summaryInput.focus();
                return;
            }

            btn.disabled = true;
            btn.innerText = "DeÄŸerlendiriliyor...";
            let correctCount = 0;
            let answeredCount = 0;
            const totalQ = currentData.questions.length;

            currentData.questions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="q_${index}"]:checked`);
                if(selected) {
                    answeredCount++;
                    if(parseInt(selected.value) === q.correct_index) correctCount++;
                }
            });

            if(answeredCount < totalQ) {
                if(!confirm(`SorularÄ±n hepsini cevaplamadÄ±n (${answeredCount}/${totalQ}). Yine de bitirmek istiyor musun?`)) return;
            }

            toggleLoader(true, "Ã–zetin ve cevaplarÄ±n deÄŸerlendiriliyor...");
            finishBtn.disabled = true;

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            try {
                const res = await fetch('/api/assess_reading', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ 
                        original_text: originalTextRaw, 
                        user_summary: summary, 
                        title: currentData.title, 
                        level: level,
                        quiz_correct_count: correctCount,
                        quiz_total_questions: totalQ
                    })
                });
                const data = await res.json();

                if(data.status === 'cheat') {
                    alert(data.feedback);
                    toggleLoader(false);
                    finishBtn.disabled = false;
                    return;
                }

                // SonuÃ§larÄ± Doldur (Final Score Eklendi)
                document.getElementById('resAiScore').innerText = data.ai_score;
                document.getElementById('resQuizScore').innerText = data.quiz_score;
                document.getElementById('resFinalScore').innerText = data.final_score; 
                document.getElementById('resXpGain').innerText = `+${data.xp_gain} XP`;
                document.getElementById('resFeedback').innerText = data.feedback;

                summaryCard.classList.add('hidden');
                quizCard.classList.add('hidden');
                finishBtn.classList.add('hidden');
                
                finalResultCard.classList.remove('hidden');
                finalResultCard.scrollIntoView({behavior: 'smooth'});

            } catch(e) {
                console.error(e);
                alert("Puanlama hatasÄ± oluÅŸtu.");
                finishBtn.disabled = false;
            } finally {
                toggleLoader(false);
            }
        };

        // --- YARDIMCI FONKSÄ°YONLAR ---
        function formatText(text) { return text.split('\n').filter(p => p.trim() !== '').map(p => `<p class="mb-4">${p}</p>`).join(''); }
        function toggleLoader(show, text="") { if(show){ loaderText.innerText=text; loader.classList.remove('hidden'); } else { loader.classList.add('hidden'); } }
        
        window.highlightEvidence = function(qIndex) {
             const evidence = currentData.questions[qIndex].evidence;
             if(!evidence) return;
             const clean = evidence.replace(/<[^>]*>?/gm, '').trim();
             document.getElementById('textContent').innerHTML = formatText(originalTextRaw);
             const pList = document.getElementById('textContent').querySelectorAll('p');
             pList.forEach(p => {
                 if(p.innerText.includes(clean)) {
                     p.innerHTML = p.innerText.replace(clean, `<span class="highlight-evidence">${clean}</span>`);
                     p.scrollIntoView({behavior: 'smooth', block: 'center'});
                 }
             });
        };
        
        window.handleSelection = async function() { 
            const selection = window.getSelection();
            const text = selection.toString().trim();
            const bubble = document.getElementById('translationBubble');
            const resultDiv = document.getElementById('translationResult');
            if (text.length > 0 && /^[a-zA-Z\s']+$/.test(text)) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                bubble.style.top = (window.scrollY + rect.top - 10) + 'px';
                bubble.style.left = (window.scrollX + rect.left + rect.width / 2) + 'px';
                bubble.classList.remove('hidden');
                resultDiv.innerText = "Ã‡evriliyor...";
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                try {
                    const res = await fetch('/translate_word', { method: 'POST', headers: {'Content-Type':'application/json', 'X-CSRFToken':csrfToken}, body: JSON.stringify({word:text}) });
                    const d = await res.json();
                    resultDiv.innerText = d.translatedText || "BulunamadÄ±";
                } catch(e) { resultDiv.innerText = "Hata"; }
            } else { bubble.classList.add('hidden'); }
        };
        
        window.addEventListener('beforeunload', () => synthesis.cancel());
        document.addEventListener('mousedown', (e) => {
            if(e.target.closest('#textContent') === null) document.getElementById('translationBubble').classList.add('hidden');
        });
    });

    const isExamNeeded = {{ 'true' if exam_needed else 'false' }};
    document.addEventListener('DOMContentLoaded', () => {
        if (isExamNeeded) {
            document.getElementById('exam-toast').classList.remove('hidden');
            if(window.lucide) lucide.createIcons();
        }
    });
    function closeToast() { document.getElementById('exam-toast').classList.add('hidden'); }
</script>
{% endblock %}